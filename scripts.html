<!-- MOD-001: ENCABEZADO [INICIO] -->
<!--
*****************************************
PROYECTO: CodeWorkShop
ARCHIVO: scripts.html
VERSI√ìN: 01.26
FECHA: 05/02/2026 09:45 (UTC-5)
*****************************************
-->
<!-- MOD-001: FIN -->

<!-- MOD-002: SCRIPT PRINCIPAL [INICIO] -->
<script>

// MOD-002-S01: VARIABLES GLOBALES [INICIO]
let codigoOriginal = '';
let modulosDetectados = [];
let moduloSeleccionado = null;
let modoEdicion = null; // 'modXmod' o 'multiMod'
// MOD-002-S01: FIN


  // MOD-002-S02: UTILIDADES GENERALES [INICIO]

  // UTILIDAD: ESCAPAR HTML (SOLO UI GENERAL)
  // ‚ö†Ô∏è NO USAR PARA MODS
  function escaparHTML(texto) {
    return texto
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
  }
  // MOD-002-S02: FIN


// MOD-002-S03: ANALISIS DE MODULOS V2 [INICIO]

function analizarModulos(modo) {
  const codigo = document.getElementById('codigoOriginal').value;

  if (!codigo.trim()) {
    mostrarNotificacion('‚ö†Ô∏è Carga un c√≥digo primero', 'warning');
    return;
  }

  // Guardar el modo de edici√≥n seleccionado
  modoEdicion = modo;

  mostrarCargando(true);

  google.script.run
    .withSuccessHandler(res => {
      mostrarCargando(false);

      if (!res.success) {
        mostrarNotificacion(res.error, 'error');
        return;
      }

      codigoOriginal = codigo;
      modulosDetectados = res.modulos;

      mostrarModulos(modulosDetectados);
      configurarModoEdicion(modo);
      
      // üÜï MOSTRAR ESTAD√çSTICAS
      if (res.estadisticas) {
        const stats = res.estadisticas;
        const mensaje = `‚úÖ Detectados: ${stats.total} MOD = ${stats.padres} MOD + ${stats.hijos} SubMOD`;
        mostrarNotificacion(mensaje, 'success');
      } else {
        // Fallback si no hay estad√≠sticas
        mostrarNotificacion(`‚úÖ ${res.modulos.length} MODs detectados`, 'success');
      }
    })
    .withFailureHandler(() => {
      mostrarCargando(false);
      mostrarNotificacion('‚ùå Error al analizar', 'error');
    })
    .parsearModulos(codigo);
}

// MOD-002-S03: FIN

// MOD-002-S04: UI ‚Äì LISTADO Y SELECCION DE MODS V3 [INICIO]
function mostrarModulos(modulos) {
  const lista = document.getElementById('listaModulos');
  lista.innerHTML = '';

  modulos.forEach((mod, index) => {
    const item = document.createElement('div');
    item.className = 'modulo-item';
    item.onclick = () => seleccionarModulo(index);
    
    // üÜï MOSTRAR L√çNEAS AL LADO DE LA DESCRIPCI√ìN
    const textoLineas = mod.lineas ? ` (${mod.lineas} l√≠neas)` : '';
    item.textContent = `${mod.id} ${mod.descripcion}${textoLineas}`;
    
    lista.appendChild(item);
  });

  document.getElementById('seccionModulos').style.display = 'block';
  
  // Asegurar que la lista est√© expandida al cargar
  const listaElement = document.getElementById('listaModulos');
  const btnCollapse = document.getElementById('btnCollapseModulos');
  listaElement.classList.remove('collapsed');
  btnCollapse.textContent = '‚ñº';
}

function seleccionarModulo(index) {
  moduloSeleccionado = modulosDetectados[index];
  
  document.querySelectorAll('.modulo-item').forEach((el, i) => {
    el.classList.toggle('selected', i === index);
  });
  
  const campoActual = document.getElementById('moduloActual');
  campoActual.value = moduloSeleccionado.codigo;
  campoActual.readOnly = true;

  document.getElementById('seccionModuloActual').style.display = 'block';
  document.getElementById('seccionNuevoModulo').style.display = 'block';

  mostrarNotificacion(`‚ÑπÔ∏è ${moduloSeleccionado.id} seleccionado`, 'info');
}

function toggleModulos() {
  const lista = document.getElementById('listaModulos');
  const btnCollapse = document.getElementById('btnCollapseModulos');
  
  lista.classList.toggle('collapsed');
  
  if (lista.classList.contains('collapsed')) {
    btnCollapse.textContent = '‚ñ∂';
  } else {
    btnCollapse.textContent = '‚ñº';
  }
}

function configurarModoEdicion(modo) {
  const areaModXMod = document.getElementById('areaModXMod');
  const areaMultiMod = document.getElementById('areaMultiMod');
  
  if (modo === 'modXmod') {
    // SOLO MOD x MOD requiere selecci√≥n previa
    areaModXMod.style.display = 'block';
    areaMultiMod.style.display = 'none';
  } else {
    // Multi MOD y Agregar MOD: textarea 4 directo
    areaModXMod.style.display = 'none';
    areaMultiMod.style.display = 'block';
    document.getElementById('seccionNuevoModulo').style.display = 'block';
  }
}
// MOD-002-S04: FIN

// MOD-002-S05: REEMPLAZO DE MODULOS [INICIO]
function aplicarCambio() {
  if (!codigoOriginal) {
    mostrarNotificacion('‚ö†Ô∏è Falta c√≥digo original', 'warning');
    return;
  }

  // Detectar el modo y ejecutar la funci√≥n correspondiente
  if (modoEdicion === 'multiMod') {
    aplicarCambioMultiple();
  } 
  else if (modoEdicion === 'nuevoMod') {
    aplicarCambioNuevo(); // üÜï H√çBRIDO: reemplaza O agrega
  }
  else {
    aplicarCambioIndividual();
  }
}

function aplicarCambioIndividual() {
  if (!moduloSeleccionado) {
    mostrarNotificacion('‚ö†Ô∏è Selecciona un m√≥dulo primero', 'warning');
    return;
  }

  const nuevoModulo = document.getElementById('nuevoModulo').value;
  
  if (!nuevoModulo.trim()) {
    mostrarNotificacion('‚ö†Ô∏è Pega el nuevo c√≥digo del m√≥dulo', 'warning');
    return;
  }

  mostrarCargando(true);

  google.script.run
    .withSuccessHandler(res => {
      mostrarCargando(false);

      if (!res.success) {
        mostrarNotificacion(res.error, 'error');
        return;
      }

      document.getElementById('codigoResultante').value = res.codigo;
      document.getElementById('seccionResultado').style.display = 'block';

      mostrarNotificacion('‚úÖ M√≥dulo reemplazado', 'success');
    })
    .withFailureHandler(() => {
      mostrarCargando(false);
      mostrarNotificacion('‚ùå Error al aplicar cambio', 'error');
    })
    .reemplazarModulo(
      codigoOriginal,
      moduloSeleccionado.id,
      nuevoModulo
    );
}

function aplicarCambioMultiple() {
  const multiModulo = document.getElementById('multiModulo').value;
  
  if (!multiModulo.trim()) {
    mostrarNotificacion('‚ö†Ô∏è Pega los m√≥dulos a reemplazar', 'warning');
    return;
  }

  mostrarCargando(true);

  google.script.run
    .withSuccessHandler(res => {
      mostrarCargando(false);

      if (!res.success) {
        mostrarNotificacion(res.error, 'error');
        return;
      }

      document.getElementById('codigoResultante').value = res.codigo;
      document.getElementById('seccionResultado').style.display = 'block';

      mostrarNotificacion(`‚úÖ ${res.modulosReemplazados} m√≥dulos reemplazados`, 'success');
    })
    .withFailureHandler(() => {
      mostrarCargando(false);
      mostrarNotificacion('‚ùå Error al aplicar cambios m√∫ltiples', 'error');
    })
    .reemplazarMultiplesModulos(
      codigoOriginal,
      multiModulo
    );
}
// MOD-002-S05: FIN


// MOD-002-S06: UTILIDADES UI V2 [INICIO]
function copiarResultado() {
  navigator.clipboard.writeText(
    document.getElementById('codigoResultante').value
  );
  mostrarNotificacion('‚úÖ C√≥digo copiado al portapapeles', 'success');
}

function reiniciar() {
  codigoOriginal = '';
  modulosDetectados = [];
  moduloSeleccionado = null;
}

function mostrarNotificacion(msg, tipo = 'success') {
  const toast = document.getElementById('toast');
  toast.className = `toast ${tipo} show`;
  toast.textContent = msg;
  setTimeout(() => toast.className = 'toast', 3000);
}

function mostrarCargando(show) {
  document
    .getElementById('loading')
    .classList.toggle('show', show);
}
// MOD-002-S06: FIN


// MOD-002-S07: ACCIONES DE HEADER [INICIO]
  function copiarUrlPdfEstandar() {
    const urlPdf =
      'https://docs.google.com/document/d/1vbbaAPpTN9nQed_OOtoQBIp9K3PfNn5wgXWhNELAhqA/export?format=pdf';

    navigator.clipboard.writeText(urlPdf);
    mostrarNotificacion('‚úÖ URL del est√°ndar copiada', 'success');
  }

  function copiarInstruccionesIA() {
    google.script.run
      .withSuccessHandler(res => {
        if (!res || !res.success) {
          mostrarNotificacion(
            res?.error || '‚ùå Error al obtener est√°ndar',
            'error'
          );
          return;
        }

        navigator.clipboard.writeText(res.texto);
        mostrarNotificacion(
          '‚úÖ Est√°ndar copiado al portapapeles',
          'success'
        );
      })
      .withFailureHandler(() => {
        mostrarNotificacion(
          '‚ùå Error al leer el est√°ndar',
          'error'
        );
      })
      .obtenerEstandar();
  }
  // MOD-002-S07: FIN


  // MOD-002-S08: LOG Y ARRANQUE [INICIO]
  console.log('‚úÖ Scripts CodeWorkShop v2.7 cargados');
  // MOD-002-S08: FIN

// MOD-002-S09: AGREGAR MOD H√çBRIDO V2 [INICIO]
function aplicarCambioNuevo() {
  const nuevoModulo = document.getElementById('multiModulo').value;  // ‚úÖ Siempre multiModulo
  
  if (!nuevoModulo.trim()) {
    mostrarNotificacion('‚ö†Ô∏è Pega los m√≥dulos en el √°rea inferior', 'warning');
    return;
  }

  mostrarCargando(true);

  google.script.run
    .withSuccessHandler(res => {
      mostrarCargando(false);
      if (!res.success) {
        mostrarNotificacion(res.error, 'error');
        return;
      }
      document.getElementById('codigoResultante').value = res.codigo;
      document.getElementById('seccionResultado').style.display = 'block';
      
      if (res.accionRealizada === 'reemplazado') {
        mostrarNotificacion('‚úÖ M√≥dulo(s) reemplazado(s)', 'success');
      } else {
        mostrarNotificacion(`‚úÖ ${res.modulosProcesados} m√≥dulo(s) procesado(s)`, 'success');
      }
    })
    .withFailureHandler(err => {
      mostrarCargando(false);
      mostrarNotificacion('‚ùå Error del servidor: ' + err, 'error');
    })
    .agregarModuloNuevo(codigoOriginal, nuevoModulo);
}
// MOD-002-S09: FIN

// MOD-002-S10: REENUMERAR C√ìDIGO [INICIO]
/**
 * Reenumera todos los m√≥dulos del c√≥digo cargado.
 * Detecta el primer intermedio y reenumera desde ah√≠.
 */
function reenumerarCodigo() {
  const codigo = document.getElementById('codigoOriginal').value;

  if (!codigo.trim()) {
    mostrarNotificacion('‚ö†Ô∏è Carga un c√≥digo primero', 'warning');
    return;
  }

  mostrarCargando(true);

  google.script.run
    .withSuccessHandler(res => {
      mostrarCargando(false);

      if (!res.success) {
        mostrarNotificacion(res.error || '‚ùå Error al reenumerar', 'error');
        return;
      }

      // Si no hab√≠a cambios necesarios
      if (res.mensaje) {
        mostrarNotificacion(res.mensaje, 'info');
        return;
      }

      // Mostrar c√≥digo reenumerado en secci√≥n de resultado
      document.getElementById('codigoResultante').value = res.codigo;
      document.getElementById('seccionResultado').style.display = 'block';

      // Mostrar estad√≠sticas si est√°n disponibles
      if (res.estadisticas) {
        const stats = res.estadisticas;
        const totalCambios = stats.etapa1.modulosProcesados + stats.etapa2.modulosProcesados;
        const mensaje = `‚úÖ Reenumeraci√≥n: ${totalCambios} cambio(s). Etapa 1: ${stats.etapa1.modulosProcesados}, Etapa 2: ${stats.etapa2.modulosProcesados}`;
        mostrarNotificacion(mensaje, 'success');
      } else {
        mostrarNotificacion('‚úÖ Reenumeraci√≥n completada exitosamente', 'success');
      })
    .withFailureHandler(err => {
      mostrarCargando(false);
      mostrarNotificacion('‚ùå Error al reenumerar: ' + err, 'error');
    })
    .reenumerarModulosCompleto(codigo);
}
// MOD-002-S10: FIN

</script>
<!-- MOD-002: FIN -->

<!-- MOD-099: NOTAS [INICIO] -->
<!--
DESCRIPCI√ìN:
Frontend de CodeWorkShop. Captura c√≥digo, env√≠a al backend y muestra resultados.

RESPONSABILIDAD:
- Captura c√≥digo del usuario
- Env√≠a a code.gs para procesamiento
- Muestra resultados y estad√≠sticas
- Gestiona UI de modo MOD x MOD y Multi MOD

ACTUALIZACI√ìN V01.19:
- MOD-002-S03: Muestra estad√≠sticas (total MOD, padres, hijos)
- MOD-002-S04 V2: Muestra conteo de l√≠neas por m√≥dulo

INTEGRACI√ìN:
Backend code.gs v01.29:
- MOD-006 v7.0: Detecci√≥n ultra agn√≥stica + conteo de l√≠neas
- MOD-008 v4.0: Validaci√≥n din√°mica
- MOD-009 v6.0: Reemplazo ultra agn√≥stico

ESTADO:
Compatible con backend ultra agn√≥stico v01.29
-->
<!-- MOD-099: FIN -->
